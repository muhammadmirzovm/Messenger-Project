{% extends 'core/base.html' %}


{% block navbar %}{% endblock %}
{% block navbar_scripts %}{% endblock %}

{% block title %}{{ room.name }}{% endblock %}

{% block content %}
<div class="container mt-4">


  <div class="mb-3 d-flex justify-content-between">
    <a href="{% url 'chat_app:room_list' %}" class="btn btn-outline-primary">
      ← Back to Rooms
    </a>
    <form action="{% url 'chat_app:leave_room' room.slug %}" method="post">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-danger">Leave Room</button>
    </form>
  </div>


  <div class="d-flex justify-content-between align-items-center">
    <h2>{{ room.name }}</h2>
    <span id="room-online-count" class="badge bg-success">Online: 0</span>
  </div>
  <p>{{ room.description|default:"No description" }}</p>


  <div class="mt-3">
    <h5>Members</h5>
    <ul id="member-list" class="list-group">
      {% for membership in memberships %}
      <li class="list-group-item {% if membership.user == request.user %}fw-bold{% endif %}">
        {{ membership.nickname|default:membership.user.username }}
      </li>
      {% empty %}
      <li class="list-group-item text-muted">No members yet.</li>
      {% endfor %}
    </ul>
  </div>


  <div class="mt-4">
  <h5>Chat</h5>
  <div id="chat-messages" class="border rounded p-3 mb-2" style="height:300px; overflow-y:auto;">
    <p class="text-muted">No messages yet.</p>
  </div>

  <div class="input-group">
    <input id="chat-input" type="text" class="form-control" placeholder="Type a message...">
    <button id="chat-send" class="btn btn-primary">Send</button>
  </div>
</div>
</div>


<script>
const roomSlug = "{{ room.slug }}";
const userId = parseInt("{{ request.user.id }}");  // for highlighting self
const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socketUrl = protocol + window.location.host + "/ws/room/" + roomSlug + "/";
const socket = new WebSocket(socketUrl);

const onlineCountElement = document.getElementById('room-online-count');
const memberListElement = document.getElementById('member-list');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');

function appendMessage(obj) {
  const p = document.createElement('p');
  const sender = obj.nickname || obj.username || "Unknown";
  const time = obj.created_at ? new Date(obj.created_at).toLocaleTimeString() : "";
  p.innerHTML = `<strong>${sender}</strong> <small class="text-muted">${time}</small>: ${obj.message}`;
  chatMessages.appendChild(p);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// WebSocket events
socket.onopen = () => console.log("✅ Connected to room WebSocket");
socket.onclose = () => console.log("❌ Disconnected from room WebSocket");

socket.onmessage = (event) => {
  const data = JSON.parse(event.data);

  // Initial history
  if (data.type === "chat_history") {
    chatMessages.innerHTML = ""; // clear placeholder
    if ((data.messages || []).length === 0) {
      chatMessages.innerHTML = `<p class="text-muted">No messages yet.</p>`;
    } else {
      data.messages.forEach(appendMessage);
    }
    return;
  }

  // Presence updates
  if (data.type === "room_presence") {
    onlineCountElement.textContent = "Online: " + data.count;
    memberListElement.innerHTML = '';
    data.users.forEach(userObj => {
      const li = document.createElement('li');
      li.textContent = userObj.nickname || userObj.username;
      li.className = 'list-group-item';
      if (userObj.id === userId) li.classList.add('fw-bold');
      memberListElement.appendChild(li);
    });
    return;
  }

  // New message
  if (data.type === "chat_message") {
    appendMessage(data);
    return;
  }
};

// Send chat on Enter key
chatInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter' && chatInput.value.trim() !== "") {
    socket.send(JSON.stringify({
      type: "chat_message",
      message: chatInput.value.trim()
    }));
    chatInput.value = '';
  }
});
</script>

{% endblock %}
